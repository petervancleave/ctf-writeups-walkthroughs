
# Malware Analysis - Malhare.exe



https://tryhackme.com/room/htapowershell-aoc2025-p2l5k8j1h4

---

Goal: Analyze a malicious HTA file disguised as a salary survey to understand what it does and how it compromises systems. 
Main topic: How attackers abuse legitimate Windows HTML Application (.hta) files for initial access and payload delivery.

**Locate the file safely**

- On the AttackBox: /root/Rooms/AoC2025/Day21/survey.hta
- **Never double-click** the file!
- Open it in a text editor:

```bash
pluma /root/Rooms/AoC2025/Day21/survey.hta
```

```text
Examine the HTA header / metadata** (inside <head>)

- Look for <HTA:APPLICATION ...> tag
- Key properties often used by attackers:
    - WINDOWSTATE="minimize" or "normal"
    - SHOWINTASKBAR="no"
    - BORDER="none"
    - CAPTION="no"
- Check <title> – in malicious files it’s often something innocent like “Salary Survey 2025” or “Employee Feedback”.

Find the script section

- Search for: <script language="VBScript"> or <script type="text/vbscript">
- This is where the malicious logic lives.

```

**Identify the main functions** In this room’s survey.hta you’ll find five key functions:

|Function|When it runs|What it does (high-level)|
|---|---|---|
|`window_onLoad()`|Automatically on HTA open|Calls `getQuestions()`|
|`getQuestions()`|Called by `window_onLoad`|Makes external HTTP request → decodes Base64 → calls `provideFeedback`|
|`provideFeedback()`|Receives decoded string|Collects system info → makes another HTTP request → **executes payload**|
|`decodeBase64()`|Helper function|Converts Base64 string → binary|
|`RSBinaryToString()`|Helper function|Converts binary data → readable string|
**Look for suspicious objects created with CreateObject()** Common ones in this file:

- InternetExplorer.Application → used to make silent HTTP requests (no visible browser window)
- WScript.Network → gathers system info (computer name, username, domain, etc.)
- WScript.Shell → used to execute commands (most dangerous part)

**Trace the execution flow**

1. HTA opens → window_onLoad() runs automatically
2. getQuestions() runs
    - Uses InternetExplorer.Application to silently GET a URL
    - Receives Base64-encoded data
    - Decodes it using decodeBase64() and RSBinaryToString()
    - Passes result to provideFeedback()
3. provideFeedback()
    - Collects system information via WScript.Network (computer name, username, etc.)
    - Builds a URL with this info as parameters (exfiltration)
    - Makes another HTTP request (likely sending stolen info to attacker)
    - **Executes additional code** using WScript.Shell.Run or similar

---





---

Q: What is the title of the HTA application?

A: Best Festival Company Developer Survey

Q: What VBScript function is acting as if it is downloading the survey questions?

A: getQuestions

Q: What URL domain (including sub-domain) is the "questions" being downloaded from?

A: survey.bestfestiivalcompany.com

Q: Malhare seems to be using typosquatting, domains that look the same as the real one, in an attempt to hide the fact that the domain is not the inteded one, what character in the domain gives this away?

A: i

Q: Malicious HTAs often include real-looking data, like survey questions, to make the file seem authentic. How many questions does the survey have?

A: 4

Q: Notice how even in code, social engineering persists, fake incentives like contests or trips hide in plain sight to build trust. The survey entices participation by promising a chance to win a trip to where?

A: South Pole

Q: The HTA is enumerating information from the local host executing the application. What two pieces of information about the computer it is running on are being exfiltrated? You should provide the two object names separated by commas.

A: ComputerName,UserName

Q: What endpoint is the enumerated data being exfiltrated to?

A: /details

Q: What HTTP method is being used to exfiltrate the data?

A: GET

Q: After reviewing the function intended to get the survey questions, it seems that the data from the download of the questions is actually being executed. What is the line of code that executes the contents of the download?

A: `runObject.Run "powershell.exe -nop -w hidden -c " & feedbackString, 0, False`

Q: It seems as if the malware site has been taken down, so we cannot download the contents that the malware was executing. Fortunately, one of the elves created a copy when the site was still active. Download the contents from [here](https://assets.tryhackme.com/additional/aoc2025/files/blob.txt). What popular encoding scheme was used in an attempt to obfuscate the download?

A: base64

Q: Decode the payload. It seems as if additional steps where taken to hide the malware! What common encryption scheme was used in the script?

A: rot13

( ROT13 because It checks for uppercase letters (ASCII 65–90) and shifts them by **+13 positions** within the 26-letter alphabet: (($c - 65 + 13) % 26) + 65
- It does the same for lowercase letters, but offset from 97: (($c - 97 + 13) % 26) + 97
- Non-letter characters are left untouched.
- The shift amount is hard-coded to 13.)

Q: Either run the script or decrypt the flag value using online tools such as CyberChef. What is the flag value?

A: THM{Malware.Analysed}

